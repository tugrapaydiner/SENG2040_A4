{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}{{ topic.title }}{% endblock title %}

{% block content %}
<h1>{{ topic.title }}</h1>
<p>
    Started by: {{ topic.author.username }}
    on {{ topic.created_at|date:"F j, Y, P" }}
</p>
<hr>

<h2>Replies</h2>

<div id="posts-container">
    {% if posts %}
    {% for post in posts %}
    <div class="post-container" style="margin-bottom: 20px; border: 1px solid #eee; padding: 10px;" id="post-{{ post.pk }}">
        <p>{{ post.content|linebreaksbr }}</p>
        <small>
            Posted by: {{ post.author.username }}
            on {{ post.created_at|date:"F j, Y, P" }}
            <span style="margin-left: 15px;">
                Likes: <span id="like-count-{{ post.pk }}">{{ post.like_count }}</span>
                {% if user.is_authenticated %}
                <button type="button"
                        class="btn btn-sm like-button {% if user in post.liked.all %}btn-danger{% else %}btn-outline-danger{% endif %}"
                        data-post-id="{{ post.pk }}"
                        data-url="{% url 'posts:like_post' pk=post.pk %}"
                        id="like-button-{{ post.pk }}"
                        style="margin-left: 5px; padding: 1px 5px; font-size: 0.8em;">
                    {% if user in post.liked.all %}Unlike{% else %}Like{% endif %}
                </button>
                {% endif %}
            </span>
        </small>

        {% if request.user == post.author %}
        <span style="margin-left: 15px;">
            <button type="button"
                    class="btn btn-sm btn-outline-secondary edit-button"
                    data-post-id="{{ post.pk }}"
                    data-content="{{ post.content }}"
                    style="padding: 1px 5px; font-size: 0.8em;"
                    data-toggle="modal"
                    data-target="#editPostModal-{{ post.pk }}">
                {# Placeholder target for edit modal #}
                Edit
            </button>
            |
            <button type="button"
                    class="btn btn-sm btn-outline-danger delete-button"
                    data-post-id="{{ post.pk }}"
                    data-toggle="modal"
                    data-target="#deleteConfirmModal-{{ post.pk }}" {# Target THIS post's delete modal #}
                    style="padding: 1px 5px; font-size: 0.8em;">
                Delete
            </button>
        </span>
        {% endif %}

        {% with photos=post.get_photos %}
        {% if photos %}
        <div class="post-photos" style="margin-top: 10px;">
            {% for photo in photos %}
            <img src="{{ photo.image.url }}" alt="Photo for post {{ post.id }}" style="max-width: 150px; height: auto; margin-right: 5px;">
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}
    </div>

    {% if request.user == post.author %} {# Only render modal if user is author #}
    <div class="modal fade" id="deleteConfirmModal-{{ post.pk }}" tabindex="-1" aria-labelledby="deleteConfirmModalLabel-{{ post.pk }}" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel-{{ post.pk }}">Confirm Deletion</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this post? This action cannot be undone.
                    <blockquote class="mt-2" style="font-size: 0.9em; border-left: 3px solid #ccc; padding-left: 10px;">
                        {{ post.content|truncatechars:100 }}
                    </blockquote>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button"
                            class="btn btn-danger confirm-delete-button"
                            data-post-id="{{ post.pk }}"
                            {# The URL will be added once the view /url is created #}
                            {# data-url="{% url 'posts:delete_post' pk=post.pk %}" #}>
                        Yes, Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endfor %} {# End of posts loop #}
    {% else %}
    <p>No replies have been posted yet.</p>
    {% endif %}
</div>

<hr>

{% if user.is_authenticated %}
<button type="button" class="btn btn-primary mb-3" data-toggle="modal" data-target="#createPostModal">
    Add Reply
</button>
<div class="modal fade" id="createPostModal" tabindex="-1" aria-labelledby="createPostModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="" id="post-reply-form">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="createPostModalLabel">Create a New Post</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    {% crispy form %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary" id="post-reply-submit-button">Post Reply</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% else %}
<p>Please <a href="{% url 'login' %}?next={{ request.path }}">login</a> to post a reply.</p>
{% endif %}

{% endblock content %}

{% block scripts %}
{{ block.super }}
<script src="{% static 'posts/js/detail.js' %}"></script>
{% endblock scripts %}